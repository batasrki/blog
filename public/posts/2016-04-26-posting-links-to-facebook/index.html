<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>(Insightful) Ramblings  | Posting links to Facebook</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.54.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.955516233bcafa4d2a1c13cea63c7b50.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Posting links to Facebook" />
<meta property="og:description" content="Tonight, I&rsquo;ll be doing something slightly different and actually, possibly relevant to my day job. I&rsquo;m going to take the links I have saved and post them on my Facebook account. Using Clojure and ReactJS! It may be an interesting exploration into interfacing with Facebook or it may not. I have no clue and isn&rsquo;t that lack of knowledge what makes the life worth living?
Let&rsquo;s go I&rsquo;m guessing I can post straight from Javascript, but I&rsquo;d like to track how links I share will be received." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/2016-04-26-posting-links-to-facebook/" />
<meta property="article:published_time" content="2016-04-26T21:20:03-04:00"/>
<meta property="article:modified_time" content="2016-04-26T21:20:03-04:00"/>

<meta itemprop="name" content="Posting links to Facebook">
<meta itemprop="description" content="Tonight, I&rsquo;ll be doing something slightly different and actually, possibly relevant to my day job. I&rsquo;m going to take the links I have saved and post them on my Facebook account. Using Clojure and ReactJS! It may be an interesting exploration into interfacing with Facebook or it may not. I have no clue and isn&rsquo;t that lack of knowledge what makes the life worth living?
Let&rsquo;s go I&rsquo;m guessing I can post straight from Javascript, but I&rsquo;d like to track how links I share will be received.">


<meta itemprop="datePublished" content="2016-04-26T21:20:03-04:00" />
<meta itemprop="dateModified" content="2016-04-26T21:20:03-04:00" />
<meta itemprop="wordCount" content="1051">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Posting links to Facebook"/>
<meta name="twitter:description" content="Tonight, I&rsquo;ll be doing something slightly different and actually, possibly relevant to my day job. I&rsquo;m going to take the links I have saved and post them on my Facebook account. Using Clojure and ReactJS! It may be an interesting exploration into interfacing with Facebook or it may not. I have no clue and isn&rsquo;t that lack of knowledge what makes the life worth living?
Let&rsquo;s go I&rsquo;m guessing I can post straight from Javascript, but I&rsquo;d like to track how links I share will be received."/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="http://example.org/" class="f3 fw2 hover-white no-underline white-90 dib">
      (Insightful) Ramblings
    </a>
    <div class="flex-l items-center">
      

      
      











    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Posting links to Facebook</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2016-04-26T21:20:03-04:00">April 26, 2016</time>      
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l">

<p>Tonight, I&rsquo;ll be doing something slightly different and actually, possibly relevant to my day job. I&rsquo;m going to take the links I have saved and post them on my Facebook account. Using Clojure and ReactJS! It may be an interesting exploration into interfacing with Facebook or it may not. I have no clue and isn&rsquo;t that lack of knowledge what makes the life worth living?</p>

<h2 id="let-s-go">Let&rsquo;s go</h2>

<p>I&rsquo;m guessing I can post straight from Javascript, but I&rsquo;d like to track how links I share will be received. I can have a <code>core.async</code> process somewhere poll the Facebook API and get data. I&rsquo;ll have to associate post IDs with the links I share.</p>

<p>I&rsquo;ve created a Facebook App from my account. The next thing to do is copy the given JS into a file somewhere. I&rsquo;m choosing to create a new file <code>js/fb-integration.js</code> and require it in the <code>views.clj</code> file at the end of the <code>body</code> declaration.</p>

<pre><code class="language-clojure">(include-js &quot;/js/fb-integration.js&quot;)
</code></pre>

<p>After loading the app in the browser and checking there are no errors, I&rsquo;m ready to do the next step. I want to log in and get permissions to post on a Facebook Page. I don&rsquo;t need to do this unless there&rsquo;s a desire to post a link to Facebook. So, I&rsquo;m going to add a button into the <code>Link</code> component much like the delete button already added. The markup for the <code>Link</code> component looks like this now.</p>

<pre><code class="language-javascript">&lt;div className={&quot;card card-block&quot;}&gt;
  &lt;h4 className=&quot;card-title&quot;&gt;
    &lt;a target=&quot;_blank&quot; href={this.props.url}&gt;{this.props.title}&lt;/a&gt;
    &lt;form onSubmit={this.handleDelete}&gt;
      &lt;input type=&quot;submit&quot; value=&quot;X&quot;/&gt;
    &lt;/form&gt;
    &lt;!-- THE NEW THING! --&gt;
    &lt;form onSubmit={this.handleFBShare}&gt;
      &lt;input type=&quot;submit&quot; value=&quot;Share!&quot; /&gt;
    &lt;/form&gt;
    &lt;!-- END --&gt;
  &lt;/h4&gt;
  &lt;p className=&quot;card-text&quot;&gt;
    Created by {this.props.client} at {this.props.created_at}
  &lt;/p&gt;
&lt;/div&gt;
</code></pre>

<p>I now need to figure out how to invoke the log in modal and have it ask for permissions. Additionally, I need to find out what permissions I need. The documentation seems to suggest that I need the <code>manage_pages</code> and <code>publish_pages</code> permissions, so I&rsquo;ll add that to the scope of permissions requested on log in. A few experiments in the browser yields results I want to see.</p>

<pre><code class="language-javascript">FB.login(function(resp) { console.log(resp) },
         {scope: ['manage_pages', 'publish_pages']});

//returns
{authResponse: Object, status: &quot;connected&quot;}

FB.api('/me/accounts', function(resp) { console.log(resp) });

//returns
{data: Array[2], paging: Object}
</code></pre>

<p>The <code>FB.api</code> call returns a list of pages with their IDs and access tokens that I can use to publish links to. I&rsquo;m going to send that info to the Clojure backend and see what happens.</p>

<h2 id="initial-front-end-implementation">Initial front-end implementation</h2>

<p>Since this is an experiment, I&rsquo;m not concerned with the code quality. I just want it to work. Propagating the event from the <code>Link</code> component to the <code>LinkListContainer</code> component works much the same way as it did in the link deletion. I&rsquo;m going to chain callbacks, which is widely accepted as &ldquo;the wrong thing to do&rdquo;, so don&rsquo;t do this in a real application. The event handler will log in, ask for all the pages using the <code>/me/accounts</code> endpoint, grab the JS object representing the page I&rsquo;d like to post to, and then send that page&rsquo;s access token and ID to the server. The server will use that information to actually make the post.</p>

<pre><code class="language-javascript">// handlers above
handleFBShare: function(data) {
  var parent = this;
  FB.login(function(response) {
    if(response.status === &quot;connected&quot;) {
      FB.api(&quot;/me/accounts&quot;, function(response) {
        var link_experiments_page = response.data.filter(function(page) {
          if(page.name === &quot;Link Experiments&quot;) {
            return page;
          }
        })[0];
        $.ajax({
          url: parent.props.url + &quot;/&quot; + data.id + &quot;/share&quot;,
          dataType: &quot;json&quot;,
          contentType: &quot;application/json&quot;,
          type: &quot;POST&quot;,
          data: JSON.stringify({access_token: link_experiments_page.access_token, page_id: link_experiments_page.id}),
          success: function(data) {
            console.log(data);
          }.bind(parent),
          error: function(xhr, status, err) {
            console.error(parent.props.url +&quot;/&quot; + data.id + &quot;/share&quot;, status, err.toString());
          }.bind(parent)
        });
      });
    }
  });
}
// render below
</code></pre>

<p>Clicking on the <code>Share</code> button illicits a 404, since the server has no endpoint set up. That&rsquo;s up next.</p>

<h2 id="initial-server-side-implementation">Initial server-side implementation</h2>

<p>This should be as easy as adding a route and a function that responds to the request.</p>

<pre><code class="language-clojure">(defn post-link-to-facebook
  [request]
  (println request)
  (let [id (Integer/parseInt (get-in request [:path-params :id]))]
    (ring-resp/response (json/write-str @links))))
</code></pre>

<p>All I want to do is inspect the request, but as I expected, this is simple. I really like well-designed languages and libraries. The data I sent from the client shows up in the <code>json-params</code> map, so I can extract the access token and the page ID as easily as the link ID.</p>

<p>I&rsquo;m going to create a function that will take in the above data and make a post. I need to pull in the great <code>http-kit</code> library, as well, so that I can make HTTP requests in a simple manner. Firstly, I&rsquo;m going to fill out the rest of the handler function.</p>

<pre><code class="language-clojure">
(defn post-link-to-facebook
  [request]
  (let [link-id (Integer/parseInt (get-in request [:path-params :id]))
        link (first (filter #(= (:id %)) @links))
        page-id (get-in request [:json-params :page_id])
        access-token (get-in request [:json-params :access_token])]
    (create-a-post page-id access-token link)
    (ring-resp/response (json/write-str @links))))
</code></pre>

<p>With that done, I&rsquo;m ready to actually make a post. Firstly, I&rsquo;m adding <code>http-kit</code> to the list of required libraries.</p>

<pre><code class="language-clojure">(:require [org.httpkit.client :as http]
          ;; all the other things)
</code></pre>

<p>Now, I&rsquo;m going to write a quick-and-dirty function to do the posting. I need to hit the <code>graph.facebook.com</code> domain with the ID of the page and its access token. The <code>message</code> field is the actual thing shown. I&rsquo;ll keep this field really simple right now.</p>

<pre><code class="language-clojure">(defn create-a-post [fb-page-id fb-page-token link]
  (let [post-url (str &quot;https://graph.facebook.com/&quot; fb-page-id &quot;/feed?message=Look%20at%20this%20link%20&quot; (:url link) &quot;&amp;access_token=&quot; fb-page-token)
        {:keys [status headers body error] :as resp} @(http/post post-url)]
    (if error
      (println &quot;Failed, exception: &quot; error)
      (println &quot;Success, status: &quot; status))
  ))
</code></pre>

<p>If I now reload the app and click <code>Share</code>, I get a post on the desired Facebook Page!</p>

<p><img src="/images/facebook-post.png" alt="facebook post" /></p>

<p>That is great. As much as I dislike Facebook&rsquo;s privacy nonsense, I have to admit that it is really easy to do things such as this. Of course, I also always enjoy Clojure&rsquo;s ability to make these things so, so simple, as well.</p>

<p>OK, so I have a few cleanup items left, but I&rsquo;m happy that it only took a couple of hours to do this feature from scratch. The time taken includes researching everything from how to actually connect to Facebook using its JS SDK, finding the relevant Graph API docs, integrating that into the existing ReactJS app and writing the backend functionality.</p>

<p>TODO:</p>

<ol>
<li>Clean up that ugly URL creation</li>
<li>Figure out how to post sane content</li>
<li>Send a response to the UI so that a shared link doesn&rsquo;t get shared again</li>
</ol>
<ul class="pa0">
  
</ul>
<div class="mt6">
        
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://example.org/" >
    &copy; 2019 (Insightful) Ramblings
  </a>
    <div>










</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
